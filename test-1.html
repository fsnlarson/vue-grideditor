<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript" src="vue.js"></script>
	<style type="text/css">
		body{font-family: sans-serif;}
		* {box-sizing: border-box;}
		.container{width:50%;float:left;background: #FFFFFF}
		.datacell{width: 49.5%;float:left;border: 1px solid #F5F5F5;height: 40px;}
		.datatext{padding:10px;}
		.dataedit {height: 100%;}
		.datacell input{width: 100%;height:100%;padding:2px 8px;font-size: 1em;background:#CEF;}
		.datacell input:focus{border:1px solid #00C;outline: none;}
		.row{clear: both;overflow: hidden;}
	</style>
</head>
<body>
<div class="wrapper">

<section id="gridtable">
	<datagrid v-model="griddata.rows" :cols="cols" @saverows = "saverows" ></datagrid>
	<div class="container" style="background: #EEF9F9; padding:10px 20px;"><pre>{{ $data }}</pre></div>
</section>

<!-- Data Grid Template -->
<template id="datagrid-template">
	<div class="container">
			<addrow cellindex="-1,-1" @saverows = "saverows"></addrow>
			<div v-for="(row,rowIndex) in value" class="row">
				<datacell v-for="(c,colIndex) in cols"
					v-model="row[c.m]"
					:cellindex="rowIndex+','+colIndex"
					:key="rowIndex+','+colIndex"
					@saverows = "saverows"
				></datacell>
			</div>
	</div>
	</div>
</template>

<!-- Data Cell template -->
<template id="datacell-template">
<div :class="['datacell',{'editing':editing}]">
	<div class="datatext" v-text="value?value:'-'" v-show="!editing" @click="editCell" ></div>
	<div class="dataedit" v-if="editing">
		<input type="text"
			:value="value"
			v-focus="true"
			@keydown.self.stop.enter="doneEdit"
		 />
	</div>
</div>
</template>

<!-- Data Cell template -->
<template id="addrow-template">
	<div class="row addrow">
		<div class="datacell">
			<div class="datatext" v-text="'+ Add Row'" v-show="!editing" @click="editCell($event)"></div>
			<div v-for="(c,colIndex) in $parent.cols" v-if="c.new && editing" class="dataedit">
				<input type="text"
					:name="c.m"
					:placeholder="c.m"
					v-model="newrow[c.m]"
					v-focus="!colIndex"
					@keyup.enter="addRow($event)"
				/>
			</div>
		</div>
	</div>
</template>

<script type="text/javascript">
var STORAGE_KEY = 'grid-vue-datarows'
var gridStorage = {
  fetch: function () {
	var griddata = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]')
	griddata.rows.forEach(function (row, index) {
	  row.id = index
	})
	gridStorage.uid = griddata.rows.length
	return griddata
  },
  save: function (rows) {
  	// console.log(rows.length);
	localStorage.setItem(STORAGE_KEY, JSON.stringify(rows))
  }
}

// Data Cell Component
var datacellComponent = Vue.extend({
	template 	: '#datacell-template',
	props 		: ['value','cellindex'],
	data 		: function(){
		return {
			newrow : {}
		}
	},
	computed	: {
		editing: function(){
			return (this.$parent.editcell == this.cellindex)?true:false;
		}
	},
	methods 	:{
		editCell:function(e){
			this.$parent.editcell = this.cellindex;
		},
		doneEdit: function(e) {
			this.$emit('input', e.target.value);
			this.$emit('saverows');
			// this.value = e.target.value;
			this.$parent.editcell 	= null;
		},
		addRow: function (e) {
			this.newrow.id = gridStorage.uid++;
			var newrow = this.newrow;
			this.$parent.cols.map(function(col,index){
				if(typeof newrow[col.m] == "undefined")
					newrow[col.m] = "";
			})
			this.$parent.value.unshift(this.newrow);
			this.$emit('saverows');
			this.newrow = {};
		},
		saverows  : function(){
			console.log("are we here?");
		}
	}
})

var addrowComponent = datacellComponent.extend({
	template 	: '#addrow-template',
})

// Data Grid Component
Vue.component('datagrid', {
	template 	: '#datagrid-template',
	props 		: ['value','cols'],
	components 	: {
		'datacell' 	: datacellComponent,
		'addrow'	: addrowComponent,
	},
	data 	: function (){
		return {
			editcell 	: null,
		}
	},
	methods: {
		saverows : function(){
			console.log("captured in datagrid component");
			this.$emit('saverows');
		}
	},
	watch : {
		value : function(v){
			console.log(v);
		}
	}
});

// v-focus on form element after showing
Vue.directive('focus', function (el,binding) {Vue.nextTick(function() { if(binding.value){ el.focus();}});})
var app = new Vue({
	data: {
		griddata: gridStorage.fetch(),
		cols : [{m:'name',new:true},{m:'year',new:false}],
	},
	watch: {
		// griddata: {
		// 	handler: function (griddata) {
		// 		console.log("Row Changed",griddata.rows.length);
		// 		gridStorage.save(griddata)
		// 	},
		// 	deep: true
		// }
	},
	methods: {
		saverows: function(){
			console.log("captured in main app");
			gridStorage.save(this.griddata);
			this.griddata = gridStorage.fetch();
		}
	},
	created: function(){
		// this.griddata = this.griddata ? this.griddata : {"rows": [{"name":"Robin Hood","year":1999,"id":0},{"name":"Queen Jolly","year":1973,"id":1},{"name":"King Jhon","year":2000,"id":2}]}
	}
});


app.$mount('#gridtable');

</script>
</body>
</html>